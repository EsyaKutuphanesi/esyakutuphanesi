{% from "security/_macros.html" import render_field_with_errors, render_field %}
{% extends "layout.html" %}
{%block title%}Esya Kutuphanesi{%endblock%}
{% block content %}
    <script>
        /*
          TODO:  There is some errors in logic of the filter. Use onclick instead of of change
        */
        $(function(){
            var firstLoad = true;
            $("select#categories").change(function(e){
                $.getJSON('/get_stuff_types/'+$(this).val(),'',function(j){
                    {%if not params['stuff_type']%}
                    stuff_type = document.getElementById('stuff_types');
                    stuff_type.innerHTML = ''
                    $.each(j, function(key,value){
                        console.log(value);
                        stuff_type.innerHTML += "<option value='"+value.id+"'>"+value.name+"</option>";
                    });
                    {%endif%}
                    {%if params['stuff_type']%}
                        if(firstLoad){
                            firstLoad = false;
                            console.log('{{params['stuff_type'].value}}')
                            $("select#stuff_types").val('{{params['stuff_type'].value}}');
                        }
                    {%endif%}
                });
            });
{#            $("select#stuff_types").change(function(e){#}
{#                var htmlString = '';#}
{#                $.getJSON('/get_categories/'+$(this).val(),'',function(j){#}
{#                    {%if not params['category']%}#}
{#                        $.each(j, function(key,value){#}
{#                            console.log(value);#}
{#                            htmlString += "<option value='"+value.id+"'>"+value.name+"</option>";#}
{#                        });#}
{#                        $("select#categories").html(htmlString);#}
{#                    {%endif%}#}
{#                    {%if params['category']%}#}
{#                        if(firstLoad){#}
{#                            firstLoad = false;#}
{#                            console.log('{{params['category'].value}}')#}
{#                            $("select#categories").val('{{params['category'].value}}');#}
{#                        }#}
{#                    {%endif%}#}
{#                    // $("select#categories").trigger("change");#}
{#                });#}
{#            });#}
            {%if params['category']%}

                var htmlString = '';
                $.getJSON('/get_categories','',function(j){
                    $.each(j, function(key,value){
                        console.log(value);
                        htmlString += "<option value='"+value.id+"'>"+value.name+"</option>";
                    });
                     $("select#categories").html(htmlString);

                     $("select#categories").val('{{params['category'].value}}');

                     $("select#categories").trigger("change");
                });
{#            {%elif params['stuff_type']%}#}
{#                $.getJSON('/get_stuff_types','',function(j){#}
{#                    stuff_type = document.getElementById('stuff_types');#}
{#                    stuff_type.innerHTML = ''#}
{#                    $.each(j, function(key,value){#}
{#                        console.log(value);#}
{#                        stuff_type.innerHTML += "<option value='"+value.id+"'>"+value.name+"</option>";#}
{#                    });#}
{#                    $("select#stuff_types").val('{{params['stuff_type'].value}}');#}
{#                    $("select#stuff_types").trigger("change");#}
{#                });#}
            {%endif%}
            $("#list_btn").click(function(){
                var category = $("select#categories option:selected").text();
                var stuff_type = $("select#stuff_types option:selected").text();
                var host = window.location.host;
                window.location = "http://"+host+"/category/"+category+"/type/"+stuff_type;
            })
        })
    </script>
    <div class="row">
        {%  if params['category']  %}
            <div class="col-md-4 col-md-offset-1 form-group">
                <select class="form-control" id="categories">
                </select>
            </div>
            <div class="col-md-4 form-group">
                <select class="form-control" id="stuff_types">
                </select>
            </div>
            <div class="col-md-2">
                <button id="list_btn" class="btn">Listele</button>
            </div>
        {%endif%}
    </div>
    <div class="row">
        <div class="col-md-12">
            <div class="row">
                {% for stuff in stuff_list%}
                  <div class="col-md-3">
                    <div class="thumbnail">
                        <a href="{{stuff.url}}">
                            {%if stuff.photos%}
                            <img src="/static/photos/{{stuff.photos[0].filename}}" />
                            {%else%}
                            <img src="/static/photos/logosari1.png" />
                            {%endif%}
                        </a>
                        <div class="caption">
                            <a href="/{{stuff.url}}">
                                <h3 style="font-size:18px; margin-top:0;">{{stuff}}</h3>
                            </a>
                        <p style="font-size:12px; height: 100px; overflow: hidden;">{{stuff.detail}}</p>
                        <p>
                            {% if stuff.is_wanted %}
                                <button type="button" style="width:100%;" class="btn btn-info" onclick="window.location.href='{{stuff.url}}'">Ödünç ver</button>
                            {% else %}
                                <button type="button" style="width:100%;" class="btn btn-success" onclick="window.location.href='{{stuff.url}}'">Ödünç iste</button>
                            {% endif %}
                        </p>
                      </div>
                    </div>
                  </div>
                {%endfor%}
            </div>
        </div>
        <div class="col-md-2"></div>
    </div>
{% endblock %}

