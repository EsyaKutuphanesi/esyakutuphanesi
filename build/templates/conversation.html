{% from "security/_macros.html" import render_field_with_errors, render_field, render_textarea_with_errors, render_radio  %}
{% extends "layout.html" %}
{%block title%}Esya Kutuphanesi{%endblock%}
{% block content %}
    <script>
        function updateRequestStatus(status){
            if (confirm("Emin misiniz?")) {
                window.location = "/conversations/{{ conversation.id }}?status="+status;
            }
        }
    </script>
        <div class="row">
            <ol class="breadcrumb" style="background:none;">
                <li><a href="/my_messages">< Mesajlara geri dön</a></li>
            </ol>
        </div>
    <div class="col-md-4 col-sm-3">

        <a href="/show_stuff/{{conversation.request.stuff.id}}">
            <img class="img-responsive" src="/photos/{{ wanted_stuff.filename}}"/>
        </a>
        <div class="row">
            <div class="row" style="margin:10px auto;">
                <div class="col-md-12 col-sm-12 text-right" style="font-size:14px;">
                    <a href="/profile/{{conversation.request.stuff.owner.id}}">{{conversation.request.stuff.owner.name}}</a> paylaştı.
                </div>
            </div>
            <div class="col-md-12 col-sm-12">
                {% if user.id == conversation.request.stuff.owner.id%}
                    {% if conversation.request.status == 0%}
                        <button class="btn btn-danger pull-right" onclick="updateRequestStatus(1)">Ödünç verdim</button>
                    {% elif conversation.request.status == 1 %}
                        <button class="btn btn-warning pull-right" onclick="updateRequestStatus(2)">Geri aldım</button>
                    {% endif%}
                {%endif%}
                {% if conversation.request.status == 2%}
                    <button class="btn btn-warning pull-right" data-toggle="modal" data-target="#reviewModal">Yorum yapmak ister misin?</button>
                {%endif%}
            </div>
        </div>
    </div>
    <div class="col-md-8 col-sm-9">
        <div class="col-md-12 col-sm-12">
            <h3 style="margin-top: 0px;">{{conversation.title}}</h3>
        </div>
        <div class="col-md-12 col-sm-12 text-right" style="margin-bottom:5px;">
            <div style="background-color: #fcf8e3; padding:5px 10px;">
                <span style="float:left; color:red;">
                    {% if conversation.request.status==1 %}
                        Eşya ödünç verildi :)
                    {% elif conversation.request.status==2 %}
                        Eşya geri alındı.
                    {% endif %}
                </span>
                <strong>Ödünç istenme süresi : </strong>{{conversation.request.duration}} gün
            </div>
        </div>
        <div class="col-md-12 col-sm-12">
            <form action="/conversations/{{ conversation.id }}" method="post">
                {{ form.hidden_tag() }}
                <div class="form-group">
                    {{ render_field_with_errors(form.message, label_visible=False, placeholder=form.message.label.text) }}
                </div>

                {{ form.submit(class_='btn btn-info pull-right')}}
            </form>
        </div>

        {% for message in conversation.messages | reverse %}
            <div class="col-md-12 col-sm-12" style="margin-top:10px;">
                <dl class="dl-horizontal">
                  <dt>{{ message.user.name }}</dt>
                  <dd>{{ message}}</dd>
                </dl>
            </div>
        {% endfor %}
    </div>

<div class="modal fade" id="reviewModal" tabindex="-1" role="dialog" aria-labelledby="requestModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">Değerlendir</h4>
            </div>
            <form action="/review" method="post">
                {{ form.hidden_tag() }}

                <div class="form-group">
                    {{ render_radio(review_form.rating) }}
                </div>
                <div class="form-group">
                    {{ render_field_with_errors(review_form.comment, label_visible=False, placeholder=review_form.comment.label.text) }}
                </div>{{ render_field_with_errors(review_form.request_id) }}
                <div class="modal-footer">
                    {{ form.submit(class_='btn btn-info pull-right')}}
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

